import os
import random
import discord
from discord.ext import commands, tasks
from myserver import server_on  # Assuming this starts your server
from discord import app_commands
from threading import Thread
from datetime import datetime, timedelta

intents = discord.Intents.default()
intents.guilds = True
intents.messages = True
intents.message_content = True
intents.members = True

bot = commands.Bot(command_prefix='!', intents=intents)

user_numbers = []
target_channel_id = 1290924217184948236
SweetDessert_role = 1218124815378940035

# Function to rank numbers
def rank_numbers():
    if len(user_numbers) == 0:
        return "No Data"

    sorted_users = sorted(user_numbers, key=lambda x: x['number'], reverse=True)
    message = "‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏Ñ‡∏ô‡∏°‡∏µ‡∏ï‡∏£‡∏≤‡πÉ‡∏´‡∏ç‡πà (Rank HSOA) :\n"

    for index, user in enumerate(sorted_users):
        message += f"{index + 1}. {user['username']}: {user['number']}\n"

    return message
    
def get_random_welcome_message(member):
    messages = [
        f"‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏™‡∏π‡πà SweetDessert, {member.mention}! ‡∏´‡∏ß‡∏±‡∏á‡∏ß‡πà‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏à‡∏∞‡∏™‡∏ô‡∏∏‡∏Å‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà üç∞",
        f"‡∏Ç‡∏≠‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏Ñ‡∏∏‡∏ì {member.mention} ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏ä‡∏∏‡∏°‡∏ä‡∏ô‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤! ‡∏´‡∏ß‡∏±‡∏á‡∏ß‡πà‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏à‡∏∞‡∏û‡∏ö‡πÄ‡∏à‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏°‡∏≤‡∏Å‡∏°‡∏≤‡∏¢ üßÅ",
        f"Hey {member.mention}, welcome to SweetDessert! ‡πÄ‡∏£‡∏≤‡∏°‡∏µ‡∏Ç‡∏ô‡∏°‡πÉ‡∏´‡πâ‡∏•‡∏≠‡∏á‡πÄ‡∏ï‡πá‡∏°‡πÑ‡∏õ‡∏´‡∏°‡∏î üçÆ",
    ]
    return random.choice(messages)

# ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ö‡∏≠‡∏ó‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
@bot.event
async def on_ready():
    print(f'Logged in as {bot.user}')
    # ‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á Application Command ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÉ‡∏´‡∏°‡πà
    try:
        synced = await bot.tree.sync()
        print(f"Synced {len(synced)} commands")
    except Exception as e:
        print(f"Error syncing commands: {e}")
    
    # ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô‡∏®‡∏∏‡∏Å‡∏£‡πå
    friday_reminder.start()

# ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°
@bot.event
async def on_member_join(member):
    channel = bot.get_channel(1218562161966841897)
   
    if channel is not None:
        # ‡πÅ‡∏ó‡πá‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏≤‡∏£ mention ‡∏Å‡πà‡∏≠‡∏ô
        await channel.send(f"{member.mention} ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö!")

        # ‡∏™‡∏£‡πâ‡∏≤‡∏á Embed ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏á‡∏°‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô
        embed = discord.Embed(
            title="üéâ ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏™‡∏π‡πà SweetDessert! üéâ",
            description=get_random_welcome_message(member),
            color=discord.Color.purple()
        )

        embed.set_thumbnail(url=member.display_avatar.url)
        embed.set_footer(text="‡∏´‡∏ß‡∏±‡∏á‡∏ß‡πà‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏à‡∏∞‡∏™‡∏ô‡∏∏‡∏Å‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà! üç®", icon_url="https://i.imgur.com/ZdfJpK4.png")

        # ‡∏™‡πà‡∏á Embed ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏õ‡∏∏‡πà‡∏°
        view = discord.ui.View()
        view.add_item(discord.ui.Button(label="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Role", url="https://discord.com/channels/1217800795177750618/1260117726861721620", style=discord.ButtonStyle.link))

        await channel.send(embed=embed, view=view)
    else:
        print("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÉ‡∏´‡∏°‡πà")

# ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô‡∏®‡∏∏‡∏Å‡∏£‡πå
@tasks.loop(time=datetime.utcnow().replace(hour=9, minute=0, second=0))  # ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏ß‡∏•‡∏≤ 9:00 UTC (‡∏´‡∏£‡∏∑‡∏≠ 16:00 ‡∏ô. ‡πÉ‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÑ‡∏ó‡∏¢)
async def friday_reminder():
    current_day = datetime.utcnow().weekday()
    if current_day == 4:  # ‡∏ñ‡πâ‡∏≤‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∑‡∏≠‡∏ß‡∏±‡∏ô‡∏®‡∏∏‡∏Å‡∏£‡πå (Friday = 4)
        channel = bot.get_channel(target_channel_id)
        if channel is not None:
            mention_role = f"<@&{SweetDessert_role}>"
            await channel.send(f"{mention_role} ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ï‡∏£‡∏≤‡πÉ‡∏´‡∏ç‡πà (HSOA) ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ!")
        else:
            print("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô")

# ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡πà‡∏á‡∏°‡∏≤
@bot.event
async def on_message(message):
    global user_numbers

    if message.author.bot:
        return

    # ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î
    if message.channel.id == target_channel_id and message.content.isdigit():
        number = int(message.content)
        username = message.author.display_name
        
        # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ user_numbers ‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        user_exists = False
        for user in user_numbers:
            if user['username'] == username:
                old_number = user['number']  # ‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡πà‡∏≤‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÄ‡∏î‡∏¥‡∏°
                user['number'] = number  # ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÄ‡∏Å‡πà‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÉ‡∏´‡∏°‡πà
                user_exists = True
                
                # ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå
                difference = number - old_number
                if old_number != 0:
                    percentage_change = (difference / old_number) * 100
                else:
                    percentage_change = 0

                # ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á
                change_direction = "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô" if difference > 0 else "‡∏•‡∏î‡∏•‡∏á" if difference < 0 else "‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á"
                await message.channel.send(
                    f"‡∏Ñ‡∏∏‡∏ì {username} ‡πÑ‡∏î‡πâ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ï‡∏£‡∏≤‡πÉ‡∏´‡∏ç‡πà (HSOA) ‡∏à‡∏≤‡∏Å {old_number} ‡πÄ‡∏õ‡πá‡∏ô {number} "
                    f"({change_direction} {abs(difference)} ‡∏´‡∏ô‡πà‡∏ß‡∏¢, {abs(percentage_change):.2f}%)"
                )
                break

        # ‡∏ñ‡πâ‡∏≤‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡πÉ‡∏´‡πâ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏£‡∏Å
        if not user_exists:
            user_numbers.append({'username': username, 'number': number})
            await message.channel.send(f"‡∏Ñ‡∏∏‡∏ì {username} ‡∏°‡∏µ‡∏ï‡∏£‡∏≤‡πÉ‡∏´‡∏ç‡πà (HSOA) : {number}")

    # ‡πÅ‡∏™‡∏î‡∏á‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö HSOA
    if message.content.lower() == '!rank':
        ranking_message = rank_numbers()
        await message.channel.send(ranking_message)

    # Reset ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    if message.content.lower() == '!clear':
        user_numbers = []
        await message.channel.send("Clear ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!")

@bot.tree.command(name='rank', description='‡πÅ‡∏™‡∏î‡∏á rank ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏ô‡∏°‡∏µ HSOA')
async def rankcommand(interaction):
    await interaction.response.send_message(rank_numbers())

# Start the bot and the server concurrently
if __name__ == "__main__":
    # Run the Flask server in a separate thread
    flask_thread = Thread(target=server_on)
    flask_thread.start()

    # Start the Discord bot
    bot.run(os.getenv('TOKEN'))
